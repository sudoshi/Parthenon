version: '3.9'

services:

  ohdsi-atlas:
    container_name: ohdsi-atlas
    platform: ${DOCKER_ARCH}
    restart: unless-stopped
    ipc: none
    privileged: false
    environment:
      WEBAPI_URL: ${BROADSEA_HOST}/WebAPI
      ATLAS_INSTANCE_NAME: ${ATLAS_INSTANCE_NAME}
      ATLAS_COHORT_COMPARISON_RESULTS_ENABLED: ${ATLAS_COHORT_COMPARISON_RESULTS_ENABLED}
      ATLAS_USER_AUTH_ENABLED: ${ATLAS_USER_AUTH_ENABLED}
      ATLAS_PLP_RESULTS_ENABLED: ${ATLAS_PLP_RESULTS_ENABLED}
      ATLAS_SECURITY_PROVIDER_NAME: ${ATLAS_SECURITY_PROVIDER_NAME}
      ATLAS_SECURITY_PROVIDER_TYPE: ${ATLAS_SECURITY_PROVIDER_TYPE}
      ATLAS_SECURITY_ICON: ${ATLAS_SECURITY_ICON}
      ATLAS_SECURITY_USE_FORM: ${ATLAS_SECURITY_USE_FORM}
      ATLAS_SECURITY_USE_AJAX: ${ATLAS_SECURITY_USE_AJAX}
      ATLAS_DISABLE_BROWSER_CHECK: ${ATLAS_DISABLE_BROWSER_CHECK}
      ATLAS_USE_EXECUTION_ENGINE: ${ATLAS_USE_EXECUTION_ENGINE}
      ATLAS_ENABLE_TAGGING_SECTION: ${ATLAS_ENABLE_TAGGING_SECTION}
      ATLAS_CACHE_SOURCES: ${ATLAS_CACHE_SOURCES}
      ATLAS_POLL_INTERVAL: ${ATLAS_POLL_INTERVAL}
      ATLAS_ENABLE_SKIP_LOGIN: ${ATLAS_ENABLE_SKIP_LOGIN}
      ATLAS_VIEW_PROFILE_DATES: ${ATLAS_VIEW_PROFILE_DATES}
      ATLAS_ENABLE_COSTS: ${ATLAS_ENABLE_COSTS}
      ATLAS_SUPPORT_URL: ${ATLAS_SUPPORT_URL}
      ATLAS_SUPPORT_MAIL: ${ATLAS_SUPPORT_MAIL}
      ATLAS_FEEDBACK_CONTACTS: ${ATLAS_FEEDBACK_CONTACTS}
      ATLAS_FEEDBACK_CUSTOM_HTML_TEMPLATE: ${ATLAS_FEEDBACK_CUSTOM_HTML_TEMPLATE}
      ATLAS_COMPANY_INFO_CUSTOM_HTML_TEMPLATE: ${ATLAS_COMPANY_INFO_CUSTOM_HTML_TEMPLATE}
      ATLAS_SHOW_COMPANY_INFO: ${ATLAS_SHOW_COMPANY_INFO}
      ATLAS_DEFAULT_LOCALE: ${ATLAS_DEFAULT_LOCALE}
      ATLAS_ENABLE_PERSON_COUNT: ${ATLAS_ENABLE_PERSON_COUNT}
      ATLAS_ENABLE_TERMS_AND_CONDITIONS: ${ATLAS_ENABLE_TERMS_AND_CONDITIONS}

    volumes:
      - ../atlas/config/config-local-template.js:/tmp/config-local.js:ro
      - ../atlas/config/envsubst.sh:/tmp/envsubst.sh:ro
      - ../atlas/config/config-gis.js:/usr/share/nginx/html/atlas/js/config-gis.js:ro
    entrypoint: ["sh", "/tmp/envsubst.sh" ]
    labels:
      - "traefik.enable=true"